<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Checkout - Pangpa_Bekery</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Checkout</h1>
    <a href="index.html">← กลับไปเลือกสินค้า</a>
  </header>

  <section class="checkout">
    <h2>กรอกข้อมูลการสั่งซื้อ</h2>
    <form id="checkout-form">
      <label>ชื่อ-นามสกุล:</label>
      <input type="text" id="name" required>

      <label>เบอร์โทร:</label>
      <input type="tel" id="phone" required>

      <label>ที่อยู่จัดส่ง:</label>
      <textarea id="address" required></textarea>

      <label>วิธีชำระเงิน:</label>
      <select id="payment" onchange="showPaymentInfo()" required>
        <option value="">-- เลือกวิธีชำระเงิน --</option>
        <option value="True Wallet">True Wallet</option>
        <option value="QR Prompt Pay">QR Prompt Pay</option>
      </select>

      <div id="payment-info" style="margin-top:10px;"></div>

      <button type="submit" style="margin-top:20px;">ยืนยันสั่งซื้อ</button>
    </form>
  </section>

  <script>
    // แสดง QR และช่องอัปโหลดสลิปตามวิธีชำระเงิน
    function showPaymentInfo(){
      let method = document.getElementById("payment").value;
      let info = document.getElementById("payment-info");

      if(method === "True Wallet"){
        info.innerHTML = `
          <p>โอนเงินผ่าน True Wallet:</p>
          <img src="img/qr-truewallet.png" alt="QR True Wallet" style="width:200px;"><br>
          <p>กรุณาอัปโหลดสลิปโอนเงิน:</p>
          <input type="file" id="slip-file" accept="image/*">
        `;
      } else if(method === "QR Prompt Pay"){
        info.innerHTML = `
          <p>โอนเงินผ่าน PromptPay:</p>
          <img src="img/qr-promptpay.png" alt="QR PromptPay" style="width:200px;"><br>
          <p>กรุณาอัปโหลดสลิปโอนเงิน:</p>
          <input type="file" id="slip-file" accept="image/*">
        `;
      } else {
        info.innerHTML = ""; // เก็บเงินปลายทางไม่ต้องอัปโหลดสลิป
      }
    }

    // ฟังก์ชันดึงข้อมูลสลิปเป็น Base64
    function getSlipBase64(){
      let fileInput = document.getElementById("slip-file");
      if(fileInput && fileInput.files.length > 0){
        let file = fileInput.files[0];
        return new Promise((resolve) => {
          let reader = new FileReader();
          reader.onload = function(){ resolve(reader.result.split(",")[1]); }
          reader.readAsDataURL(file);
        });
      } else {
        return Promise.resolve(null);
      }
    }

    // ยืนยันสั่งซื้อ
    document.getElementById("checkout-form").addEventListener("submit", async function(e){
      e.preventDefault();

      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      if(cart.length === 0){
        alert("ตะกร้าว่าง กรุณาเลือกสินค้าก่อน");
        window.location.href = "index.html";
        return;
      }

      let slipBase64 = await getSlipBase64();

      let orderData = {
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        address: document.getElementById("address").value,
        payment: document.getElementById("payment").value,
        cart: cart,
        slip: slipBase64 // ถ้าไม่มีสลิป จะเป็น null
      };

      // บันทึก order ไว้ localStorage เพื่อใช้ใน waiting.html
      localStorage.setItem("latestOrder", JSON.stringify(orderData));

      // ล้างตะกร้า
      localStorage.removeItem("cart");

      // เด้งไปหน้า waiting.html
      window.location.href = "waiting.html";
    });
  </script>
</body>
</html>
